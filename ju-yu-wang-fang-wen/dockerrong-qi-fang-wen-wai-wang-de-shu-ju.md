但是把NAT关掉了以后，虽然内网可以互ping了，但是Docker容器可能上不去网呀。第一个路由器如果自动NAT 了172.17.0.2还好，但要是没有人给Docker容器做NAT，Docker容器就不能上网了，那我们的CDNS也就没法用了。那么如何既保证Docker容器访问外网的数据包被NAT，又保证内网通信不被NAT呢？只要稍微修改一下iptables规则就好了，如下

sudo iptables -t nat -A POSTROUTING -s 172.17.0.2 ! -d 192.168.12.1/24 -j MASQUERADE

上面的iptables规则通过对内外网流量的分离实现区别的NAT对待，就可以既保证Docker容器正常上网，也可以被内网其他主机访问了。

可能会有这么一种情况，上面所说的第一台路由器不是什么智能路由器，或者你没有权限在那个路由器上配置路由条目，让目标为172.17.0.0/16的数据包通过路由器进行路由。同时你的局域网其他电脑是XP系统的，也没法手动配置路由规则，这该怎么办呢？

方法一：

现在以要访问Docker容器的局域网主机为Windows XP系统为例，虽然WinXP不能手动配置路由规则，但是我们可以配置网关，只要我们把网关设置为192.168.12.107也就是我们的宿主机，目标地址为172.17.0.0/16的IP包就会发送到宿主机上，而宿主机不同于第一个路由器，它是知道如何路由这些IP包的。于是我们就可以在WinXP上ping通Docker容器了

方法二：



如果你不想修改windows的网关（怕上不去网）可以为windows系统单独设置172.17.0.1/24的目标地址的数据包路由到192.168.12.107，可以使用下面的命令



route -p add 172.17.0.1 MASK 255.255.255.0  192.168.12.107 METRIC 3



